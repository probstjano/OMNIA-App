<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gehgeschwindigkeit</title>

  <!-- Zentrale Dateien -->
  <link rel="stylesheet" href="app-style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.legacy.min.js"></script>
  <script src="robotoBase64.js"></script>
</head>

<body class="assessment-page">

<h1>Gehgeschwindigkeit</h1>
<p>Gehgeschwindigkeit ist einer der am besten untersuchten Gesundheitsmarker im Alter.</p>
<p>Im Cenplex-Plan als <strong>Messung</strong> vorhanden. Hier eintragen fÃ¼r Normwerte und Score-Ãœbertragung.</p>
<p>Gemessen wird die Ã¼bliche/gewohnte Geschwindigkeit. Verschiedene Distanzen mit oder ohne Anlaufstrecke werden teils verwendet. 
Im Domizilphysio ist meist nur eine 4 m- oder 3 m-Strecke ohne Anlauf realistisch (Teil des SPPB).</p>
<p>Detailliertes Protokoll des SPPB inkl. Gehgeschwindigkeit: 
  <a href="https://probstjano.github.io/OpenPdf/SPPB_Protokoll.pdf" target="_blank" rel="noopener">SPPB Protokoll (PDF)</a></p>
<p><strong>Wichtig:</strong> Die 4 m-Messung ohne Anlauf reduziert die gemessene Geschwindigkeit um ca. 0,12 m/s im Vergleich zu anderen Verfahren.
Dies sollte beim Interpretieren der Graphik berÃ¼cksichtigt werden. Die hier verwendeten Normwerte basieren vollstÃ¤ndig auf dem 4 m-Verfahren des SPPB.</p>

<!-- CONTENT-LOCK START -->
<form>
  <label>Strecke:</label>
  <label><input type="radio" name="strecke" value="3" checked> 3 m</label>
  <label><input type="radio" name="strecke" value="4"> 4 m</label>

  <label>Zeit (Sek.):</label>
  <input type="number" id="gehzeit" step="0.01">

  <label>Alter:</label>
  <input type="number" id="age" min="60" max="120">

  <label>Geschlecht:</label>
  <select id="sex">
    <option value="men">MÃ¤nnlich</option>
    <option value="women">Weiblich</option>
  </select>

  <button type="button" onclick="calculateGait()">âœ… Geschwindigkeit berechnen</button>
  <button type="button" onclick="downloadPDF()">ğŸ“„ Als PDF speichern</button>
  <button type="button" onclick="toggleNormsGait()">ğŸ“Š Normwerte & Cut-Offs anzeigen</button>
</form>

<div id="result"></div>
<div id="normwerteGait" class="hidden"></div>

<script>
  let gaitVisible = false;
  let lastSpeed = 0;

  const gaitNorms = {
    men: {
      60: { P5: 0.88, P10: 0.95, P25: 1.08, P50: 1.22, P75: 1.35, P90: 1.50, P95: 1.58 },
      65: { P5: 0.85, P10: 0.92, P25: 1.04, P50: 1.18, P75: 1.33, P90: 1.47, P95: 1.57 },
      70: { P5: 0.81, P10: 0.88, P25: 0.99, P50: 1.13, P75: 1.29, P90: 1.44, P95: 1.54 },
      75: { P5: 0.74, P10: 0.81, P25: 0.91, P50: 1.05, P75: 1.22, P90: 1.37, P95: 1.46 },
      80: { P5: 0.65, P10: 0.72, P25: 0.83, P50: 0.97, P75: 1.14, P90: 1.30, P95: 1.35 },
      85: { P5: 0.56, P10: 0.64, P25: 0.74, P50: 0.89, P75: 1.06, P90: 1.22, P95: 1.25 }
    },
    women: {
      60: { P5: 0.89, P10: 0.95, P25: 1.07, P50: 1.22, P75: 1.37, P90: 1.52, P95: 1.61 },
      65: { P5: 0.82, P10: 0.88, P25: 1.00, P50: 1.16, P75: 1.31, P90: 1.46, P95: 1.56 },
      70: { P5: 0.74, P10: 0.81, P25: 0.92, P50: 1.09, P75: 1.24, P90: 1.39, P95: 1.48 },
      75: { P5: 0.67, P10: 0.73, P25: 0.85, P50: 1.02, P75: 1.18, P90: 1.32, P95: 1.41 },
      80: { P5: 0.60, P10: 0.66, P25: 0.79, P50: 0.96, P75: 1.12, P90: 1.25, P95: 1.33 },
      85: { P5: 0.54, P10: 0.59, P25: 0.73, P50: 0.90, P75: 1.06, P90: 1.17, P95: 1.25 }
    }
  };

  function calculateGait() {
    const dist = parseFloat(document.querySelector('input[name="strecke"]:checked').value);
    const zeit = parseFloat(document.getElementById("gehzeit").value);
    const speed = (!isNaN(dist) && !isNaN(zeit) && zeit > 0) ? (dist / zeit).toFixed(2) : "-";
    document.getElementById("result").innerText = `Gehgeschwindigkeit: ${speed} m/s`;
    lastSpeed = parseFloat(speed);
  }

  function downloadPDF() {
    const doc = new jsPDF();
    let y = 10;
    const dist = document.querySelector('input[name="strecke"]:checked').value;
    const zeit = document.getElementById("gehzeit").value || "-";
    const speed = (dist && zeit && zeit > 0) ? (dist / zeit).toFixed(2) : "-";

    doc.setFontSize(16);
    doc.text("Auswertung Gehgeschwindigkeit", 10, y);
    y += 10;
    doc.setFontSize(12);
    doc.text(`Strecke: ${dist} m`, 10, y += 7);
    doc.text(`Zeit: ${zeit} s`, 10, y += 7);
    doc.text(`Gehgeschwindigkeit: ${speed} m/s`, 10, y += 7);
    doc.save("gehgeschwindigkeit.pdf");
  }

  function toggleNormsGait() {
    const btn = document.querySelector("button[onclick='toggleNormsGait()']");
    const norms = document.getElementById("normwerteGait");

    if (gaitVisible) {
      norms.classList.add("hidden");
      btn.innerText = "ğŸ“Š Normwerte & Cut-Offs anzeigen";
      gaitVisible = false;
      return;
    }

    const age = parseInt(document.getElementById("age").value);
    const sex = document.getElementById("sex").value;
    const speed = lastSpeed;

    const nearest = [60, 65, 70, 75, 80, 85].reduce((a, b) =>
      Math.abs(b - age) < Math.abs(a - age) ? b : a
    );

    const P = gaitNorms[sex][nearest];

    let faster = "-";
    const percentiles = [5,10,25,50,75,90,95];
    const values = percentiles.map(p => P["P"+p]);

    if (speed <= values[0]) faster = 5;
    else if (speed >= values[6]) faster = 95;
    else {
      for (let i = 0; i < values.length - 1; i++) {
        if (speed >= values[i] && speed <= values[i+1]) {
          const p0 = percentiles[i], p1 = percentiles[i+1];
          const v0 = values[i], v1 = values[i+1];
          const frac = (speed - v0) / (v1 - v0);
          faster = Math.round(p0 + frac * (p1 - p0));
          break;
        }
      }
    }

    norms.innerHTML = "";

    if (speed <= 0.8) {
      norms.innerHTML += `<p><strong>âš ï¸ Gehgeschwindigkeit â‰¤ 0.8 m/s â†’ Hinweis auf Low Physical Performance & Sturzgefahr </strong></p>`;
    }

    norms.innerHTML += `
      <h3>Norwegische Referenzwerte â€“ Gehgeschwindigkeit (${nearest} Jahre â€“ ${sex === 'men' ? 'MÃ¤nner' : 'Frauen'})</h3>
      <table>
        <tr><th>Perzentil</th><th>m/s</th></tr>
        ${Object.entries(P).map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
      </table>
      <p>â†’ Geschwindigkeit ist schneller als bei: <strong>${faster}%</strong> der Vergleichsgruppe.</p>

      <h3>Interpretationsgrafik:</h3>
      <div class='graph-container'>
        <img src='walking speeds.jpg' alt='Walking Speed Interpretation' id='speedImage'>
        <div id='speedMarker'></div>
        <div id='correctedMarker'></div>
      </div>`;

    setTimeout(() => {
      const img = document.getElementById("speedImage");
      const pxWidth = img.clientWidth;
      const maxSpeed = 1.5;

      const marker = document.getElementById("speedMarker");
      const corrected = document.getElementById("correctedMarker");

      const posRaw = Math.min(Math.max((speed / maxSpeed) * pxWidth, 0), pxWidth);
      const posCorr = Math.min(Math.max(((speed + 0.12) / maxSpeed) * pxWidth, 0), pxWidth);

      marker.style.left = `${posRaw}px`;
      corrected.style.left = `${posCorr}px`;
    }, 100);

    norms.classList.remove("hidden");
    btn.innerText = "ğŸ“‰ Normwerte & Cut-Offs verbergen";
    gaitVisible = true;
  }
</script>
<!-- CONTENT-LOCK END -->

<!-- Einheitlicher Footer -->
<div class="footer-nav">
  <button class="secondary" onclick="goBack()">â¬…ï¸ ZurÃ¼ck</button>
  <button class="primary" onclick="goHome()">ğŸ  Hauptseite</button>
</div>

<!-- Zentrales Verhalten -->
<script src="app-core.js"></script>

</body>
</html>
