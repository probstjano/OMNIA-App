<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2-Minuten Step Test (2MST)</title>

  <!-- Zentrale Styles -->
  <link rel="stylesheet" href="app-style.css">

  <!-- Bibliotheken f√ºr PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="robotoBase64.js"></script>
</head>

<body class="assessment-page">

  <!-- HEADER -->
  <h1>2-Minuten Step Test (2MST)</h1>
  <p class="subtitle">
    Test der kardiovaskul√§ren und muskul√§ren Ausdauer. 
    Alternative zum 6-Minuten-Gehtest bei Platzmangel oder f√ºr eingeschr√§nkte Patienten.
  </p>
  <p>
    Durchf√ºhrung: Patient steht auf der Stelle und hebt abwechselnd die Knie, 
    bis diese eine vorab markierte H√∂he (Mitte zwischen Patella und Spina iliaca anterior superior) erreichen. 
    Ziel: So viele Wiederholungen wie m√∂glich in 2 Minuten.
  </p>
  <p>
    Im Cenplex-Behandlungsplan als <strong>Messung</strong> dokumentieren. 
    Hier eintragen f√ºr Normwerte:
  </p>

  <!-- CONTENT -->
  <form id="form2mst">
    <label>Anzahl Kniehebungen in 2 Minuten:</label>
    <input type="number" id="steps" step="1" />

    <label>Herzfrequenz vor:</label>
    <input type="number" id="HFvor"/>

    <label>Herzfrequenz nach:</label>
    <input type="number" id="HFnach"/>

    <label>SpO‚ÇÇ vor:</label>
    <input type="number" id="SPO2vor"/>

    <label>SpO‚ÇÇ nach:</label>
    <input type="number" id="SPO2nach"/>

    <label>BORG (0-10):</label>
    <input type="number" id="BORG" min="0" max="10" />

    <label>BORG Dyspnoe (0-10):</label>
    <input type="number" id="BORGD" min="0" max="10" />

    <label>Alter:</label>
    <input type="number" id="age" min="18" max="100" />

    <label>Geschlecht:</label>
    <select id="sex">
      <option value="men">M√§nnlich</option>
      <option value="women">Weiblich</option>
    </select>

    <button type="button" class="primary" id="toggleBtn2MST" onclick="toggleNorms2MST()">üìä Normwerte anzeigen</button>
    <button type="button" class="secondary" onclick="generatePDF()">üìÑ Als PDF speichern</button>
  </form>

  <!-- NORMWERTE -->
  <div id="normwerte2MST" class="hidden"></div>

  <!-- RESULT & NAVIGATION -->
  <div id="result"></div>

  <div class="footer-nav">
    <button class="secondary" onclick="goBack()">‚¨ÖÔ∏è Zur√ºck</button>
    <button class="primary" onclick="goHome()">üè† Hauptseite</button>
  </div>

  <!-- LOGIK -->
  <script>
    let normVisible = false;

    const norms2MST = {
      men: {
        20: [70, 87, 105, 120, 140],
        30: [68, 85, 100, 115, 135],
        40: [65, 80, 95, 110, 130],
        50: [60, 75, 90, 105, 125],
        60: [55, 70, 85, 100, 120],
        70: [50, 65, 80, 95, 115]
      },
      women: {
        20: [65, 80, 95, 110, 130],
        30: [60, 75, 90, 105, 125],
        40: [55, 70, 85, 100, 120],
        50: [50, 65, 80, 95, 115],
        60: [45, 60, 75, 90, 110],
        70: [40, 55, 70, 85, 105]
      }
    };

    function getNearestAgeGroup2MST(age) {
      const ageGroups = [20, 30, 40, 50, 60, 70];
      return ageGroups.reduce((a, b) =>
        Math.abs(b - age) < Math.abs(a - age) ? b : a
      );
    }

    function toggleNorms2MST() {
      const btn = document.getElementById("toggleBtn2MST");
      const div = document.getElementById("normwerte2MST");

      if (normVisible) {
        div.classList.add("hidden");
        btn.innerText = "üìä Normwerte anzeigen";
        normVisible = false;
        return;
      }

      const steps = parseInt(document.getElementById("steps").value);
      const age = parseInt(document.getElementById("age").value);
      const sex = document.getElementById("sex").value;

      if (isNaN(steps) || isNaN(age)) {
        div.innerText = "Bitte g√ºltige Werte eingeben.";
        div.classList.remove("hidden");
        return;
      }

      const ageGroup = getNearestAgeGroup2MST(age);
      const P = norms2MST[sex][ageGroup];
      const percentiles = [2.5, 25, 50, 75, 97.5];
      let faster = "-";

      if (!P) {
        div.innerText = "Keine Normdaten vorhanden.";
        div.classList.remove("hidden");
        return;
      }

      if (steps <= P[0]) faster = 2;
      else if (steps >= P[4]) faster = 98;
      else {
        for (let i = 0; i < P.length - 1; i++) {
          if (steps >= P[i] && steps <= P[i + 1]) {
            const p0 = percentiles[i], p1 = percentiles[i + 1];
            const v0 = P[i], v1 = P[i + 1];
            const frac = (steps - v0) / (v1 - v0);
            faster = Math.round(p0 + frac * (p1 - p0));
            break;
          }
        }
      }

      div.innerHTML = `
        <h3>Schweizer Referenzwerte (${ageGroup} J., ${sex === "men" ? "M√§nner" : "Frauen"})</h3>
        <table>
          <tr><th>Perzentil</th><th>Kniehebungen</th></tr>
          ${percentiles.map((p, i) => `<tr><td>P${p}</td><td>${P[i]}</td></tr>`).join("")}
        </table>
        <p>‚Üí Diese Leistung liegt √ºber dem Wert von <strong>${faster}%</strong> der Vergleichsgruppe.</p>
      `;
      div.classList.remove("hidden");
      btn.innerText = "üìâ Normwerte verbergen";
      normVisible = true;
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("2-Minuten Step Test", 10, 15);
      doc.setFontSize(12);

      const steps = document.getElementById("steps").value;
      const HFvor = document.getElementById("HFvor").value;
      const HFnach = document.getElementById("HFnach").value;
      const SPO2vor = document.getElementById("SPO2vor").value;
      const SPO2nach = document.getElementById("SPO2nach").value;
      const BORG = document.getElementById("BORG").value;
      const BORGD = document.getElementById("BORGD").value;

      doc.text(`Kniehebungen: ${steps}`, 10, 30);
      doc.text(`Herzfrequenz vor Test: ${HFvor} bpm`, 10, 38);
      doc.text(`Herzfrequenz nach Test: ${HFnach} bpm`, 10, 46);
      doc.text(`SpO‚ÇÇ vor Test: ${SPO2vor}%`, 10, 54);
      doc.text(`SpO‚ÇÇ nach Test: ${SPO2nach}%`, 10, 62);
      doc.text(`BORG Anstrengung: ${BORG}/10`, 10, 70);
      doc.text(`BORG Dyspnoe: ${BORGD}/10`, 10, 78);

      window.open(doc.output("bloburl"), "_blank");
    }
  </script>

  <!-- ZENTRALES JS -->
  <script src="app-core.js"></script>

</body>
</html>
