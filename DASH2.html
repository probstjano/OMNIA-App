<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickDASH ‚Äì Fragebogen</title>

  <!-- Zentrale Dateien -->
  <link rel="stylesheet" href="app-style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="robotoBase64.js"></script>

  <style>
    .table-scroll {
      overflow-x: auto;
      margin: 14px 0;
    }
    table {
      border-collapse: collapse;
      min-width: 700px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
    }
    .section-title {
      margin-top: 24px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .patient-box {
      padding: 15px;
      border: 1px solid #bbb;
      border-radius: 8px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    .patient-box input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 12px;
    }
  </style>
</head>

<body class="assessment-page">

<h1>Quick-Disabilities of the Arm, Shoulder and Hand (QuickDASH)</h1>

<p>
Bitte beantworten Sie alle Fragen gem√§√ü Ihrem Zustand in der vergangenen Woche, indem Sie das entsprechende Feld ankreuzen.
</p>

<form id="qdForm">

<!-- ------------------------------------------- -->
<!-- PATIENT INFORMATION -->
<!-- ------------------------------------------- -->
<div class="patient-box">
  <h3>Patientenangaben</h3>

  <label>Vorname:</label>
  <input type="text" id="pVorname" />

  <label>Nachname:</label>
  <input type="text" id="pNachname" />

  <label>Geburtsdatum:</label>
  <input type="date" id="pDOB" />
</div>

<!-- ================= MAIN 11 ITEMS ================= -->

<div class="table-scroll">
<table>
  <tr>
    <th></th>
    <th>√ºberhaupt nicht eingeschr√§nkt</th>
    <th>ein wenig eingeschr√§nkt</th>
    <th>m√§√üig eingeschr√§nkt</th>
    <th>sehr eingeschr√§nkt</th>
    <th>nicht m√∂glich</th>
  </tr>

  <tr><td>1. Ein festverschlossenes Glas √∂ffnen</td>
    <td><input type="radio" name="q1" value="1"></td>
    <td><input type="radio" name="q1" value="2"></td>
    <td><input type="radio" name="q1" value="3"></td>
    <td><input type="radio" name="q1" value="4"></td>
    <td><input type="radio" name="q1" value="5"></td>
  </tr>

  <tr><td>2. Schwere Hausarbeit (z. B. W√§nde abwaschen, Boden putzen)</td>
    <td><input type="radio" name="q2" value="1"></td>
    <td><input type="radio" name="q2" value="2"></td>
    <td><input type="radio" name="q2" value="3"></td>
    <td><input type="radio" name="q2" value="4"></td>
    <td><input type="radio" name="q2" value="5"></td>
  </tr>

  <tr><td>3. Eine Einkaufstasche oder einen Aktenkoffer tragen</td>
    <td><input type="radio" name="q3" value="1"></td>
    <td><input type="radio" name="q3" value="2"></td>
    <td><input type="radio" name="q3" value="3"></td>
    <td><input type="radio" name="q3" value="4"></td>
    <td><input type="radio" name="q3" value="5"></td>
  </tr>

  <tr><td>4. Ihren R√ºcken waschen</td>
    <td><input type="radio" name="q4" value="1"></td>
    <td><input type="radio" name="q4" value="2"></td>
    <td><input type="radio" name="q4" value="3"></td>
    <td><input type="radio" name="q4" value="4"></td>
    <td><input type="radio" name="q4" value="5"></td>
  </tr>

  <tr><td>5. Ein Messer benutzen, um Lebensmittel zu schneiden</td>
    <td><input type="radio" name="q5" value="1"></td>
    <td><input type="radio" name="q5" value="2"></td>
    <td><input type="radio" name="q5" value="3"></td>
    <td><input type="radio" name="q5" value="4"></td>
    <td><input type="radio" name="q5" value="5"></td>
  </tr>

  <tr><td>6. Freizeitaktivit√§ten mit Druck/Stoss (z. B. Golf, H√§mmern, Tennis)</td>
    <td><input type="radio" name="q6" value="1"></td>
    <td><input type="radio" name="q6" value="2"></td>
    <td><input type="radio" name="q6" value="3"></td>
    <td><input type="radio" name="q6" value="4"></td>
    <td><input type="radio" name="q6" value="5"></td>
  </tr>
</table>
</div>

<div class="table-scroll">
<table>
  <tr>
    <th></th>
    <th>keine Schwierigkeiten</th>
    <th>geringe Schwierigkeiten</th>
    <th>m√§√üige Schwierigkeiten</th>
    <th>erhebliche Schwierigkeiten</th>
    <th>nicht m√∂glich</th>
  </tr>

  <tr><td>7. Beeintr√§chtigung normaler sozialer Aktivit√§ten?</td>
    <td><input type="radio" name="q7" value="1"></td>
    <td><input type="radio" name="q7" value="2"></td>
    <td><input type="radio" name="q7" value="3"></td>
    <td><input type="radio" name="q7" value="4"></td>
    <td><input type="radio" name="q7" value="5"></td>
  </tr>

  <tr><td>8. Einschr√§nkung in Arbeit/anderen Aktivit√§ten?</td>
    <td><input type="radio" name="q8" value="1"></td>
    <td><input type="radio" name="q8" value="2"></td>
    <td><input type="radio" name="q8" value="3"></td>
    <td><input type="radio" name="q8" value="4"></td>
    <td><input type="radio" name="q8" value="5"></td>
  </tr>

  <tr><td>9. Schmerzen in Schulter/Arm/Hand</td>
    <td><input type="radio" name="q9" value="1"></td>
    <td><input type="radio" name="q9" value="2"></td>
    <td><input type="radio" name="q9" value="3"></td>
    <td><input type="radio" name="q9" value="4"></td>
    <td><input type="radio" name="q9" value="5"></td>
  </tr>

  <tr><td>10. Kribbeln in Schulter/Arm/Hand</td>
    <td><input type="radio" name="q10" value="1"></td>
    <td><input type="radio" name="q10" value="2"></td>
    <td><input type="radio" name="q10" value="3"></td>
    <td><input type="radio" name="q10" value="4"></td>
    <td><input type="radio" name="q10" value="5"></td>
  </tr>

  <tr><td>11. Schlafst√∂rungen wegen Schmerzen</td>
    <td><input type="radio" name="q11" value="1"></td>
    <td><input type="radio" name="q11" value="2"></td>
    <td><input type="radio" name="q11" value="3"></td>
    <td><input type="radio" name="q11" value="4"></td>
    <td><input type="radio" name="q11" value="5"></td>
  </tr>
</table>
</div>

<!-- ================== OPTIONAL MODULE: WORK ================== -->

<h2 class="section-title">Arbeits- und Berufs-Modul (optional)</h2>

<p>Bitte geben Sie Ihre/n Arbeit/Beruf hier an:</p>
<input type="text" id="workText">

<label><input type="checkbox" id="workNone"> Ich bin nicht berufst√§tig.</label>

<div class="table-scroll">
<table>
  <tr>
    <th></th>
    <th>keine Schwierigkeiten</th>
    <th>geringe Schwierigkeiten</th>
    <th>m√§√üige Schwierigkeiten</th>
    <th>erhebliche Schwierigkeiten</th>
    <th>nicht m√∂glich</th>
  </tr>

  <tr><td>12. in der √ºblichen Art und Weise zu arbeiten?</td>
    <td><input type="radio" name="w12" value="1"></td>
    <td><input type="radio" name="w12" value="2"></td>
    <td><input type="radio" name="w12" value="3"></td>
    <td><input type="radio" name="w12" value="4"></td>
    <td><input type="radio" name="w12" value="5"></td>
  </tr>

  <tr><td>13. aufgrund von Schmerzen Ihre √ºbliche Arbeit?</td>
    <td><input type="radio" name="w13" value="1"></td>
    <td><input type="radio" name="w13" value="2"></td>
    <td><input type="radio" name="w13" value="3"></td>
    <td><input type="radio" name="w·Éò·Éô"><input type="radio" name="w13" value="4"></td>
    <td><input type="radio" name="w13" value="5"></td>
  </tr>
  
  <tr><td>14. so gut zu arbeiten, wie Sie es m√∂chten?</td>
    <td><input type="radio" name="w14" value="1"></td>
    <td><input type="radio" name="w14" value="2"></td>
    <td><input type="radio" name="w14" value="3"></td>
    <td><input type="radio" name="w14" value="4"></td>
    <td><input type="radio" name="w14" value="5"></td>
  </tr>

  <tr><td>15. die bisher gewohnte Zeit mit Arbeit zu verbringen?</td>
    <td><input type="radio" name="w15" value="1"></td>
    <td><input type="radio" name="w15" value="2"></td>
    <td><input type="radio" name="w15" value="3"></td>
    <td><input type="radio" name="w15" value="4"></td>
    <td><input type="radio" name="w15" value="5"></td>
  </tr>
</table>
</div>

<!-- ================== OPTIONAL MODULE: SPORT ================== -->

<h2 class="section-title">Sport- und Musik-Modul (optional)</h2>

<p>Bitte geben Sie Ihre Sportart oder Ihr Musikinstrument an:</p>
<input type="text" id="sportText">

<label><input type="checkbox" id="sportNone"> Ich treibe keinen Sport oder spiele kein Instrument.</label>

<div class="table-scroll">
<table>
  <tr>
    <th></th>
    <th>keine Schwierigkeiten</th>
    <th>geringe Schwierigkeiten</th>
    <th>m√§√üige Schwierigkeiten</th>
    <th>erhebliche Schwierigkeiten</th>
    <th>nicht m√∂glich</th>
  </tr>

  <tr><td>16. Ihr Instrument spielen / Sport treiben</td>
    <td><input type="radio" name="s16" value="1"></td>
    <td><input type="radio" name="s16" value="2"></td>
    <td><input type="radio" name="s16" value="3"></td>
    <td><input type="radio" name="s16" value="4"></td>
    <td><input type="radio" name="s16" value="5"></td>
  </tr>

  <tr><td>17. aufgrund von Schmerzen Ihr Instrument/Sport</td>
    <td><input type="radio" name="s17" value="1"></td>
    <td><input type="radio" name="s17" value="2"></td>
    <td><input type="radio" name="s17" value="3"></td>
    <td><input type="radio" name="s17" value="4"></td>
    <td><input type="radio" name="s17" value="5"></td>
  </tr>

  <tr><td>18. so gut, wie Sie m√∂chten</td>
    <td><input type="radio" name="s18" value="1"></td>
    <td><input type="radio" name="s18" value="2"></td>
    <td><input type="radio" name="s18" value="3"></td>
    <td><input type="radio" name="s18" value="4"></td>
    <td><input type="radio" name="s18" value="5"></td>
  </tr>

  <tr><td>19. die bisher gewohnte Zeit dabei verbringen</td>
    <td><input type="radio" name="s19" value="1"></td>
    <td><input type="radio" name="s19" value="2"></td>
    <td><input type="radio" name="s19" value="3"></td>
    <td><input type="radio" name="s19" value="4"></td>
    <td><input type="radio" name="s19" value="5"></td>
  </tr>
</table>
</div>

<button type="button" class="primary" onclick="calculateQD()">‚úÖ Score berechnen</button>
<button type="button" class="secondary" onclick="generatePDF()">üìÑ PDF erstellen</button>

<div id="result"></div>

<!-- ============================================================= -->
<!-- ==================== CONTENT-LOCK START ===================== -->
<!-- ============================================================= -->

<script>
function calculateScale(values) {
  const answered = values.filter(v => v !== null);
  if (answered.length < values.length - 1) return null;
  const sum = answered.reduce((a,b)=>a+b,0);
  return ((sum/answered.length - 1) * 25).toFixed(1);
}

function calculateQD() {
  let main = [];
  for (let i = 1; i <= 11; i++) {
    const el = document.querySelector("input[name='q"+i+"']:checked");
    main.push(el ? parseInt(el.value) : null);
  }
  const quickdash = calculateScale(main);

  if (quickdash === null) {
    document.getElementById("result").innerHTML =
      "<p><strong>QuickDASH:</strong> Es darf maximal eine Antwort fehlen.</p>";
    return;
  }

  let workScore = null;
  if (!document.getElementById("workNone").checked) {
    let w = [];
    for (let i = 12; i <= 15; i++) {
      const el = document.querySelector("input[name='w"+i+"']:checked");
      w.push(el ? parseInt(el.value) : null);
    }
    if (w.every(v => v !== null)) workScore = calculateScale(w);
  }

  let sportScore = null;
  if (!document.getElementById("sportNone").checked) {
    let s = [];
    for (let i = 16; i <= 19; i++) {
      const el = document.querySelector("input[name='s"+i+"']:checked");
      s.push(el ? parseInt(el.value) : null);
    }
    if (s.every(v => v !== null)) sportScore = calculateScale(s);
  }

  let html = `<p><strong>QuickDASH Score:</strong> ${quickdash} / 100</p>`;
  if (workScore !== null) html += `<p><strong>Arbeits-/Berufs-Score:</strong> ${workScore} / 100</p>`;
  if (sportScore !== null) html += `<p><strong>Sport-/Musik-Score:</strong> ${sportScore} / 100</p>`;

  document.getElementById("result").innerHTML = html;
}

function generatePDF() {

  const vorname = document.getElementById("pVorname").value.trim();
  const nachname = document.getElementById("pNachname").value.trim();
  const dob = document.getElementById("pDOB").value;

  if (!vorname || !nachname || !dob) {
    alert("Bitte Vorname, Nachname und Geburtsdatum eingeben.");
    return;
  }

  const dobClean = dob.replaceAll("-", "_");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.addFileToVFS("Roboto-Regular.ttf", window.robotoBase64);
  doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
  doc.setFont("Roboto", "normal");
  doc.setFontSize(12);

  let y = 15;
  const left = 15;
  const right = 190;
  const lineHeight = 8;

  function addSectionTitle(title) {
    doc.setFontSize(14);
    doc.setFont(undefined, "bold");
    doc.text(title, left, y);
    y += lineHeight;
    doc.setFontSize(12);
    doc.setFont(undefined, "normal");
  }

  function ensureSpace() {
    if (y > 270) { doc.addPage(); y = 20; }
  }

  async function savePDFDirect(pdfBlob) {
  try {
    const handle = await window.showSaveFilePicker({
      suggestedName: "QuickDASH.pdf",
      types: [{
        description: "PDF",
        accept: { "application/pdf": [".pdf"] }
      }]
    });

    const writable = await handle.createWritable();
    await writable.write(pdfBlob);
    await writable.close();

    alert("PDF wurde erfolgreich gespeichert.");
  } catch (err) {
    console.log("Speichern abgebrochen:", err);
  }
}

  function addQuestion(label, value) {
    const wrapped = doc.splitTextToSize(label, 150);
    wrapped.forEach((line, idx) => {
      doc.text(line, left, y);
      if (idx === 0) doc.text(String(value), right, y, { align: "right" });
      y += lineHeight;
      ensureSpace();
    });
    y += 2;
    ensureSpace();
  }

  // HEADER
  doc.setFontSize(16);
  doc.setFont(undefined, "bold");
  doc.text("QuickDASH ‚Äì Auswertung", left, y);
  y += 12;

  doc.setFontSize(12);
  doc.setFont(undefined, "normal");
  doc.text(`Name: ${vorname} ${nachname}`, left, y); y += 8;
  doc.text(`Geburtsdatum: ${dob}`, left, y); y += 12;

  // MAIN ITEMS
  addSectionTitle("Hauptskala (QuickDASH)");

  const questionsMain = {
    q1: "1. Ein festverschlossenes Glas √∂ffnen",
    q2: "2. Schwere Hausarbeit",
    q3: "3. Eine Einkaufstasche / Aktenkoffer tragen",
    q4: "4. R√ºcken waschen",
    q5: "5. Messer benutzen",
    q6: "6. Freizeitaktivit√§ten mit Sto√ü/Druck",
    q7: "7. Beeintr√§chtigung sozialer Aktivit√§ten",
    q8: "8. Einschr√§nkung in Arbeit/Alltag",
    q9: "9. Schmerzen in Schulter / Arm / Hand",
    q10:"10. Kribbeln in Schulter / Arm / Hand",
    q11:"11. Schlafst√∂rungen wegen Schmerzen"
  };

  for (let k in questionsMain) {
    const el = document.querySelector(`input[name='${k}']:checked`);
    const v = el ? parseInt(el.value) : "-";
    addQuestion(questionsMain[k], v);
  }

  y += 6; ensureSpace();

  // WORK MODULE
  if (!document.getElementById("workNone").checked) {
    addSectionTitle("Arbeits- / Berufs-Modul");

    const workQs = {
      w12: "12. Arbeiten wie √ºblich",
      w13: "13. Schmerzen beeinflussen die Arbeit",
      w14: "14. So gut arbeiten wie gew√ºnscht",
      w15: "15. Gewohnte Zeit arbeiten"
    };

    for (let k in workQs) {
      const el = document.querySelector(`input[name='${k}']:checked`);
      const v = el ? parseInt(el.value) : "-";
      addQuestion(workQs[k], v);
    }

    y += 6; ensureSpace();
  }

  // SPORT MODULE
  if (!document.getElementById("sportNone").checked) {
    addSectionTitle("Sport- / Musik-Modul");

    const sportQs = {
      s16: "16. Instrument/Sport aus√ºben",
      s17: "17. Schmerzen beim Instrument/Sport",
      s18: "18. So gut wie gew√ºnscht aus√ºben",
      s19: "19. Gewohnte Zeit verbringen"
    };

    for (let k in sportQs) {
      const el = document.querySelector(`input[name='${k}']:checked`);
      const v = el ? parseInt(el.value) : "-";
      addQuestion(sportQs[k], v);
    }

    y += 6; ensureSpace();
  }

  // SCORES
  addSectionTitle("Ergebnisse");

  const resultLines = document.getElementById("result").innerText.split("\n");
  resultLines.forEach(line => {
    doc.text(line, left, y);
    y += lineHeight;
    ensureSpace();
  });

  y += 8;
  doc.setFont(undefined, "bold");
  const today = new Date().toLocaleDateString("de-CH");
  doc.text("Datum: " + today, left, y);

  // FILENAME
 const fileName = `QuickDASH_${vorname}_${nachname}_${dobClean}.pdf`;
doc.save(fileName);


  // RESET EVERYTHING
  resetQDForm();
}


function resetQDForm() {

  document.getElementById("pVorname").value = "";
  document.getElementById("pNachname").value = "";
  document.getElementById("pDOB").value = "";

  const inputs = document.querySelectorAll("input[type=radio], input[type=checkbox]");
  inputs.forEach(i => i.checked = false);

  const texts = document.querySelectorAll("input[type=text], input[type=number]");
  texts.forEach(t => {
    if (t.id !== "pVorname" && t.id !== "pNachname" && t.id !== "pDOB")
      t.value = "";
  });

  document.getElementById("result").innerHTML = "";
}

</script>

<!-- ====================== CONTENT-LOCK END ====================== -->

<div class="footer-nav">
  <button class="secondary" onclick="goBack()">‚¨ÖÔ∏è Zur√ºck</button>
  <button class="primary" onclick="goHome()">üè† Hauptseite</button>
</div>

<script src="app-core.js"></script>

</body>
</html>
